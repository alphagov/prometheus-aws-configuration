#cloud-config
users:
  - name: alertmanager
    system: true

  - name: davidking
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC2a1hthz3fr/odHHUDPaRT0NpHNF6AK3LrnMm9x737eP3SQBejjqSMreUikYh36jTv4w5LiQ63npVlMp1zlQXAtc11st2tVEM+KiQQgWLlVUzNQCN/LPPlDOtR0oYDYUVQo/fZ5EBK6pi5f3jA9tMXghnSNvoUELSvuJmKYgRHRr4k1nl+8SKFs/ZdjEJDzZAnoZe8CEYT4J43HW0EKieUBf0KhbxUXfNNoe17FF5CH3z3/06Ebq6JaqinwUOb357SlV6k5+NARHgwITKYvajVKwrSggx/6WgcjEEKLwZWiHguPJakkr+oM7RKTn2kAeLEkegZGimYatsRxt592W+GzMpf5JXEfVnvfzQ39cSHHb4OLpCGDTXJadPgy7dNyRiHvwJD0qC6x4sTpAwWqQZxozAYXtKSg02v/b0Ai30AduHGhcaIV3/l/jkcluJ3LVtFp7xIyk4EvTnuJAC4+xRN42f+Zcv2iRc8/q4JRSiJ9XC/k4+3wrJ2bE7wLFWpsr91TAfvqg4kEOXA1KKIcASu+8Q5CFR3dGdSWNK/FYNReS1QMsrZp4tZvm50mL7H0NokQGkGTvBbLdZ7Lqj7tPe8uf4XoTxMbAmRUuhZOps0pgL6IIigDhUeXcnczIlg2lQRcIRxu9EQ44Qv+0QZp+5eZLJxgcklg4Z4JbHr7REb0w== david.king@digital.cabinet-office.gov.uk

  - name: chrispatuzzo
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDOUbe2nGDjtS1GAS0b8O03VEu+61ONjPA0aF4UmyDLw2y4tUVAquZp/zmjBX7MmNUSGHJ2HNz88eNXrtSM9kvjRrGXBUA+TB0ztaSj09tm3gpAsM8r8evT2CocUYjnVpA6V5gQOERa96c+pp2i9q1YCKkiIrOWqCpLdiNWk1RKbN4zAKUi5m/JXG5PrR05UG1x4qTGP2GazpPo92h1JVkccoqyeehzrCtmpJGWaw6twBlWZqoaxTHAJUu8F7YUPhw6//Jxv4uJcbl73tGEfwLIYGIhY2l4l9ajzXEqG7x51xMXXpSZEvbSvDBwgrSQSvSt911M9hWqCpEl2ToEVh1meMKtGOFMQzdC4z0qtPuweWn5BW3YnV8/4eBO3WDvoyBnP1cAXfu/S8ZW1apRdDSfPvFObZjn4ed3uUMmG+oUlg0yip7vjKgO+X5ktLq4/Z1wUtAV1dUk9MdTuerB4cPQ00w3kc0aa1YgWUmxNwnGHuumk0f4fo/J4DLn8evZyE3eAqtQAPgEsoGgNzRQsR8GIepil9n68lnDva5gHHrxdWrmNmRwQEjSfb48ZoAdj/0IbyolgwBJz1yrYdbu0SVkP/bpFunp/AO93nlhtLjeJPp8e5cgjNIyN90gNTwMGMKdUQAaG5SotgaU9Hy1EzW1IGE7mMmp/y6ZL61oBtCwrQ== chris.patuzzo@digital.cabinet-office.gov.uk

  - name: javiermarquez
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCgFAWj3tmZJyECfGaRPRnoH3vN4THILLPwl5PxXqd+UNcUFjS9UbMWIN4MBWGmX9sWWHEp0wHYUL5N+yYkXPIWi0ICrMP6DdZ6bR7OpUTRrblwOs69CmRIz9DRRVFstimceSyJg9n1Tvn8eDUGB6GgtrYhtSkRcEOdPLm4+2Hs8+Lm1AGOdZtVosrOeYUTHlhMUcJoppwvJhudEvDRuAqdlJb3EpgGmhB4/d8WXka36caCzmnubNgiR6bWylCUtyEtHk+Gdb2naV5WFkB+xRLzOCdrBS9rLl6UKKMBKRKti6c1SyQGP98ynwFaM+J9wiykXfpMFJRQ00UOkwyNa6hV45yy0O7zsPrFM+uIUMjHEROGB3uzhD/lZC/kferCmlLZncVkW4eNXIiWwm64piTFhhApEluyPG+9Zyg5quPh7Z6iMqgsoXEJOqQ01sS0XVSuG9+b0hXN6qLScFhRcS7x7oi60DSmhjwk1+rMYtmpGftBxpu5KslpygsN4ba13MUqvShjeeuNzAha+pGkSEvE/oR67voZlUqGeHipyZ3ox0dZ4YC7kGXu0jy17bEPeKWRv7+q95RShSKMVYAbR9CkI9gnaZ/nDU7OTP/yXjyvuf2HOk5iMBspRHZNiiEYfdFV8BpIxcM+4NDfnaB4tO4mDoBSqj8gO7ErAq3bP5sCCw== javier.marquez@digital.cabinet-office.gov.uk

  - name: jonathanhallam
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCbhuGtTqXfhGAJUREY8foyy522FQ9djFwYAat0QU2C8eg8TnoiGOxdJaHg3JRikDEJVrpjGyCs3PJMUoTOzeb29qt99fhMAajSEohAXZVFbDv8RUCE3S6EiZNi/F4aV9Mq86rbKOgJTPAnIBr3En6qnBR7Z7Xvu8ooVcAiB8dozFFSbgNitpjVLIFUx10LnzqwtI4TrLKP+aM5HwmIZ0B90cJOwfMOaD2tOqldRfowcaYAX0zloUxS6lTS8PSwLr2T27xT44OhvG6aNyVzNbXkhZphQ5qEPI0NIzjtb3GkiE17ApZIF3iAa422ONlz+LbGQrjFdAtvCgjDZ3McA+gddbbS1s5cg+dU7X6HM3F8bfasd4B1UJwRA18XfLHDhSRQsETfLsDHUgrosJTLAxmx41SPY8CSShVDx6q9M6POalzqU/2V924RvaODrbimfGBR64JZ8mbvnNB9kwxm2dBx+jDx51dgTs7k3+YjvYKWRVq1qJtgFFQcaH1nZagrj9SCKJ7Won5UfsZM32VS6QNVtavCpVSeaz26ajuMBnKqNIAP2fL0j/QDsRdBCrZGAH09QJ2Y1+N2I4pjb0Cr5/dbd++hf3rdNdRt/5pYjlr1x1enPTqfsZKKuSNKR+lkp6ttx7dlphxtRzqsuQqz3tImKwUXkxaMeKmSb4j/j7bGTw== jonathan.hallam@digital.cabinet-office.gov.uk

  - name: davidjeche
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCmTARrfMKQQWI8f3IWLDXUc+M79rY2UgEvRxEXObMcCCwT7NyOw12Es2tmo4iu633JB4vtZNfmkk1mrPiD1SHDr5KYMGuGwwYxy4LKn6dl4lM66XXmnFAST/O/13rLJEJk6sCRUqgbtIg/iI3om3iANaWALlrid3GM9LISEN1F2UAXH2tDRo4W7Ctq4nUu+IzeRjR5fbfwrsjaD64pp0dTjJK60lShcfAGTP5zTmiyRC55KBt7XeopVOZ8KkoCfnJXnxLJLu7vAzMgarIvsnCqfE0MRftd6zEUe4a3MEoLZbB4Gbx7egMUSrABIdf35yD9IHvNc3+YJpwXNl3NybPjyKs8xa8blJ3BpYvOup+/oToPk7/T9LGtf95vmR3g5c2deC1XIHaR1ghjx+9OaZzeVF/C0pQZ7YnWFEjU4JRm4hXMAy8Nv6Wvkhudq2bNNjWqfPgRLDnF0wmFWa4RYtaquqMoBkMVqbyCVWaIz99MDlm2O0Gz8inmuIghkrjFLSFfZ0XBpz1Ei4/2go0Swr0PEmFJ90jsBwsmKjmTAtuIk/MpGgY/mTcmQ73g7YqGQjwExYQQuhXoB8OD/GC1EVwESGDc2UHyxizY+jQ+v1u33TR2ldaPbIxY2qzWEE12wM0qfEApyC4k3+ZzJahBzBXf6fRQqFyNNWv7Z4aMJJ3bZw== david.jeche@digital.cabinet-office.gov.uk

package_update: true
package_upgrade: true
packages: ['chrony', 'nginx']

write_files:
  - content: |
      global:
    owner: root:root
    path: /etc/alertmanager/alertmanager.yml
    permissions: 0644
  - content: |
      [Unit]
      Description=alertmanager

      [Service]
      User=alertmanager
      ExecStart=/opt/alertmanager/alertmanager --config.file="/etc/alertmanager/alertmanager.yml"
      WorkingDirectory=/opt/alertmanager

      [Install]
      WantedBy = multi-user.target
    owner: root:root
    path: /etc/systemd/system/alertmanager.service
    permissions: 0644
  - owner: root:root
    path: /etc/filebeat/filebeat.yml
    permissions: 0444
    content: |
      filebeat.prospectors:
      - type: log
        enabled: true
        paths:
          - /var/log/nginx/*.log
        fields:
          type: nginx-access
        fields_under_root: true
        encoding: utf-8
        exclude_files: [".gz"]
        ignore_older: 3h

      output.logstash:
        hosts: ["${logstash_endpoint}:${logstash_port}"]
        loadbalance: true
        ssl.enabled: true
  - content: |
      server {
        listen 80 default_server;
        server_name ${domain_name};
        auth_basic "Prometheus";
        auth_basic_user_file /etc/nginx/.htpasswd;

        location / {
          proxy_pass  http://localhost:9093;
        }
      }
    owner: root:root
    path: /etc/nginx/sites-available/default
    permissions: 0644
  - owner: root:root
    path: /etc/nginx/.htpasswd
    permissions: 0444
    content: "grafana:$apr1$LDmrTU1C$i1TWO7EiXgmVVOm3xkdpr0"

runcmd:
  - [ whoami ]
  - [ deluser, ubuntu ]
  - [ service, sshd, restart ]
  - [ bash, -c, "echo 'server 169.254.169.123 prefer iburst' >> /etc/chrony/chrony.conf" ] # Configure Amazon Time Sync
  - [ service, chrony, restart ]
  - [ mkdir, /opt/alertmanager ] 
  - [ chown, -R, "alertmanager:alertmanager", /opt/alertmanager ]
  - [ systemctl, enable, --now, alertmanager.service ] 
  - [ add-apt-repository, "ppa:certbot/certbot", -y ]
  - [ wget, -q, "https://github.com/prometheus/alertmanager/releases/download/v${alertmanager_version}/alertmanager-${alertmanager_version}.linux-amd64.tar.gz", -P, /tmp ]
  - [ tar, xzvf, /tmp/alertmanager-${alertmanager_version}.linux-amd64.tar.gz, --strip-components=1, -C, /opt/alertmanager ]
  - [ cp, /opt/alertmanager/simple.yml, /etc/alertmanager/alertmanager.yml]
  - [ bash, -c, "echo 'deb https://artifacts.elastic.co/packages/6.x/apt stable main' >> /etc/apt/sources.list.d/elastic-6.x.list" ]
  - [ bash, -c, "wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | apt-key add -" ]
  - [ apt-get, update ]
  - 'apt-get install -o Dpkg::Options::="--force-confold" filebeat python-certbot-nginx -y'
  - [ certbot, ${real_certificate == "yes" ? "" : "--staging"}, -d, ${domain_name}, -m, ${lets_encrypt_email}, --authenticator, standalone, --installer, nginx, --pre-hook, "nginx -s stop", --post-hook, "nginx", --agree-tos, -n, --redirect ]
  - [ systemctl, enable, filebeat ]
  - [ reboot ]

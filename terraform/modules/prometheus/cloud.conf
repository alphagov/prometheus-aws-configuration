#cloud-config
users:
  - name: prometheus
    system: true

  - name: davidking
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC2a1hthz3fr/odHHUDPaRT0NpHNF6AK3LrnMm9x737eP3SQBejjqSMreUikYh36jTv4w5LiQ63npVlMp1zlQXAtc11st2tVEM+KiQQgWLlVUzNQCN/LPPlDOtR0oYDYUVQo/fZ5EBK6pi5f3jA9tMXghnSNvoUELSvuJmKYgRHRr4k1nl+8SKFs/ZdjEJDzZAnoZe8CEYT4J43HW0EKieUBf0KhbxUXfNNoe17FF5CH3z3/06Ebq6JaqinwUOb357SlV6k5+NARHgwITKYvajVKwrSggx/6WgcjEEKLwZWiHguPJakkr+oM7RKTn2kAeLEkegZGimYatsRxt592W+GzMpf5JXEfVnvfzQ39cSHHb4OLpCGDTXJadPgy7dNyRiHvwJD0qC6x4sTpAwWqQZxozAYXtKSg02v/b0Ai30AduHGhcaIV3/l/jkcluJ3LVtFp7xIyk4EvTnuJAC4+xRN42f+Zcv2iRc8/q4JRSiJ9XC/k4+3wrJ2bE7wLFWpsr91TAfvqg4kEOXA1KKIcASu+8Q5CFR3dGdSWNK/FYNReS1QMsrZp4tZvm50mL7H0NokQGkGTvBbLdZ7Lqj7tPe8uf4XoTxMbAmRUuhZOps0pgL6IIigDhUeXcnczIlg2lQRcIRxu9EQ44Qv+0QZp+5eZLJxgcklg4Z4JbHr7REb0w== david.king@digital.cabinet-office.gov.uk

  - name: jonathanhallam
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCbhuGtTqXfhGAJUREY8foyy522FQ9djFwYAat0QU2C8eg8TnoiGOxdJaHg3JRikDEJVrpjGyCs3PJMUoTOzeb29qt99fhMAajSEohAXZVFbDv8RUCE3S6EiZNi/F4aV9Mq86rbKOgJTPAnIBr3En6qnBR7Z7Xvu8ooVcAiB8dozFFSbgNitpjVLIFUx10LnzqwtI4TrLKP+aM5HwmIZ0B90cJOwfMOaD2tOqldRfowcaYAX0zloUxS6lTS8PSwLr2T27xT44OhvG6aNyVzNbXkhZphQ5qEPI0NIzjtb3GkiE17ApZIF3iAa422ONlz+LbGQrjFdAtvCgjDZ3McA+gddbbS1s5cg+dU7X6HM3F8bfasd4B1UJwRA18XfLHDhSRQsETfLsDHUgrosJTLAxmx41SPY8CSShVDx6q9M6POalzqU/2V924RvaODrbimfGBR64JZ8mbvnNB9kwxm2dBx+jDx51dgTs7k3+YjvYKWRVq1qJtgFFQcaH1nZagrj9SCKJ7Won5UfsZM32VS6QNVtavCpVSeaz26ajuMBnKqNIAP2fL0j/QDsRdBCrZGAH09QJ2Y1+N2I4pjb0Cr5/dbd++hf3rdNdRt/5pYjlr1x1enPTqfsZKKuSNKR+lkp6ttx7dlphxtRzqsuQqz3tImKwUXkxaMeKmSb4j/j7bGTw== jonathan.hallam@digital.cabinet-office.gov.uk

  - name: davidjeche
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCmTARrfMKQQWI8f3IWLDXUc+M79rY2UgEvRxEXObMcCCwT7NyOw12Es2tmo4iu633JB4vtZNfmkk1mrPiD1SHDr5KYMGuGwwYxy4LKn6dl4lM66XXmnFAST/O/13rLJEJk6sCRUqgbtIg/iI3om3iANaWALlrid3GM9LISEN1F2UAXH2tDRo4W7Ctq4nUu+IzeRjR5fbfwrsjaD64pp0dTjJK60lShcfAGTP5zTmiyRC55KBt7XeopVOZ8KkoCfnJXnxLJLu7vAzMgarIvsnCqfE0MRftd6zEUe4a3MEoLZbB4Gbx7egMUSrABIdf35yD9IHvNc3+YJpwXNl3NybPjyKs8xa8blJ3BpYvOup+/oToPk7/T9LGtf95vmR3g5c2deC1XIHaR1ghjx+9OaZzeVF/C0pQZ7YnWFEjU4JRm4hXMAy8Nv6Wvkhudq2bNNjWqfPgRLDnF0wmFWa4RYtaquqMoBkMVqbyCVWaIz99MDlm2O0Gz8inmuIghkrjFLSFfZ0XBpz1Ei4/2go0Swr0PEmFJ90jsBwsmKjmTAtuIk/MpGgY/mTcmQ73g7YqGQjwExYQQuhXoB8OD/GC1EVwESGDc2UHyxizY+jQ+v1u33TR2ldaPbIxY2qzWEE12wM0qfEApyC4k3+ZzJahBzBXf6fRQqFyNNWv7Z4aMJJ3bZw== david.jeche@digital.cabinet-office.gov.uk

  - name: kentsang
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWORD:ALL
    ssh-authorized-keys:
      - ssh-rsa
      AAAAB3NzaC1yc2EAAAADAQABAAABAQDRWn9zLfFsuybkeW3aUYxp3bN5ID6bzPq8iJH8P5FWasaWo2b0WX6TigpmlAUs5pPUk2Ed4aPccR54Z2LNT+6noQCMID3SCKRzUOlnmOtF9WWrhat3wOIyFhF71PrhcKFdb7Lsf60853v1QgAFaFuWWA5pRmTdrQ7W0ikIqQRMoUzLZzbl+fzmN+gF8Os7ZuJo9Et3pDHwVWrkbqNWRITrTwmPPl8BnnkOZzWibQ+WkYKB1pn9pEltv+pwZffUIU8xpgw1jHShY6qdjgKk9fFiWh5IJjjS5Uw0BDHR6sLe8e4t03sbMhSM6Ch7p6oN6WVtM3w7HyZlyoA8Iy/1jDTP kentsang@gds3982.local

  - name: danielroseman
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWORD:ALL
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDcz+lw8fLHK2IHyIOs4w29QO0zT6I98l0m5JrapSsK9ZUASS2svj7EvinMdJJ2NQQ4fqhYMD67xB2gzhug/SEpYpIicg3aUDdQEJyQulWLigH9rRFYjFv5d6jkFkRUHc4XRd31PFc6tjTgpstzPaL1uO20XlDIaU1U2+LyUplENVkVtTuNqyVPfg8qjtzHGWswr16E8ouKtfzAuTAmkuVS19cjXiflSuXD5v8vXsVzpNbyoXDjoeu443ZY8MOavZMD/7ClrZd43m/Yi154I42xJ68uM+3R4uuU6OQgcOnNhwRnyJ21jFk7ohnipVmTxB5oUjXuh0gPQSfOkCQPvddwsd/0dmfLEKidAIrwcUllI0qngSjkei0M693Wn9zJmdYoyOTpksCpEsmSpeF5ALYOXedlZfa6WuJu7SxozfuaQScJONu5TZbIS5mM/1zRVwB15cdZ+qgH1WCG9wjFWTH3CerqfnMxqpB80nxHcKD6r/FJ7tRVpHY9CaW9iAjZ97d7Hh6MTb8Jksg1F0os0c/hSOChFX/hJpmeGnQIEdu4hE7U/zt7gVxalx6446BOPdDePDcPae8ngQAutRDNI6/MtL0QAcxDUEnW2KD9QVatvwEh3kdta+EJBUOiWAjEBlpMa34509mBI1H8JKa3wAxpQ0u9tzIzsXzoxsYiUPjXkQ== daniel.roseman@digital.cabinet-office.gov.uk

  - name: deanwilson
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWORD:ALL
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDAmm4kdSdiwYnIhn9wcuNGmTQllNNcaKALRT8z/3Q0Z+vSkqnhIA6gHWFZn7ZZ0u8Zfv5rig+lyJNPZ6e+1uwxCtLABNe8G1NPUdgqhirblBDy0uhLaeiCcwOP/oiZ/M94+LxM2aPLoA9rwR47rviXUwiJ3rjQV4IZzGDuB/p1d7ttaBra39HMkqz5K1Y+I7T9mhCuoU4Rd88NHVx4NmseUQTStdulH6sy+shARMUg2M4PoXEKcWasJUd2s7CuuWa3ZHjL7EQePM1eqgUFPQloac98f3RUVAfVb9AbPhA4t/zewOZS1sYf1kxO6lrGw1P7qbXTmHUR5eTGeW/hKkZSbz5VZeN6ZtihQ3mogzmP+bsDaiuAfF2LQWijwQI7M7xjk7NBjvFfCkmnw1MymSC26vnIrb+ITfPefgi2M+uaL6HXsQvgdEL6VT1pTewD8494UJtPARf472npBWXrMjDpier711rMY5HtSwenq6KE0DHFp1bFXZ+gUZeMzvyIynB4HmyNGZpZf41Lh8uenOy49/ouO9aHMN8lcRLEz9aPQXyjAWT+FooXRQjT+BZWZ3A5t1IJB7Mfbxsah+7wE+CHOtpydL4bDR+wGIR4dm65YegeBviMN2FlCle6CnU2baDK23LTCYJalBV8K17a9ydxvHgelf0nvabTb/f93PQhjQ== deanwilson@gds0092.local


package_update: true
package_upgrade: true
packages: ['chrony', 'nginx', 'awscli']

mounts:
  - [ /dev/xvdh1, /mnt, auto]

write_files:
  - content: |
      global:
        scrape_interval: 15s
      alerting:
        alertmanagers:
          - static_configs:
            - targets: ['10.0.0.38:9093']
      rule_files:
        - "/etc/prometheus/alerts/*"
      scrape_configs:
        - job_name: prometheus
          scrape_interval: 5s
          static_configs:
            - targets: ['localhost:9090']
        - job_name: paas-targets
          scheme: http
          proxy_url: 'http://localhost:8080'
          file_sd_configs:
            - files: ['/etc/prometheus/targets/*.json']
              refresh_interval: 30s
        - job_name: 'HTTP-blackbox-check'
          metrics_path: /probe
          params:
            module: [http_2xx]
          static_configs:
            - targets:
              - https://www.unixdaemon.net
              - https://chris-test-app.cloudapps.digital
              - https://dropwizard-example.cloudapps.digital
              - https://mysql-exporter-paas.cloudapps.digital
              - https://http-simulator.cloudapps.digital/metrics
              - https://alerter.cloudapps.digital/
          relabel_configs:
            - source_labels: [__address__]
              target_label: __param_target
            - source_labels: [__param_target]
              target_label: instance
            - target_label: __address__
              replacement: 127.0.0.1:9115
    owner: root:root
    path: /etc/prometheus/prometheus.yml
    permissions: 0644
  - content: |
      groups:
      - name: HTTP-SVC-BASE-CHECKS
        rules:
        - alert: RequestsReponseTimeBelow
          expr: probe_duration_seconds{job="HTTP-blackbox-check"} > 2
          for: 1m
          labels:
            severity: "P3"
          annotations:
            summary: "Service is taking longer than 2 seconds to respond"
            description: "The service name is {{ $labels.job }}. The URL under test is the following {{ $labels.instance }}"
           #receivers:

        - alert: HTTPAvailabilityCheck
          expr: probe_success != 1
          for: 30s
          labels:
            severity: "P1"
          annotations:
            summary: "Service is not avalible at endpoint"
            description: "The service name is {{ $labels.job }} is no longer reachable from external. The following URL is no longer reachable {{ $labels.instance }}"
          #receivers:

        - alert: 4xxAboveAcceptableThreshold
          expr: http_requests_total{status=~"4.."} >= 10
          for: 3m
          labels:
            severity: "P2"
          annotations:
            summary: "The number of 4xx http status codes"
            description: "The service {{ $labels.job }} on instance {{ $labels.instance }} is experiencing a high number of HTTP 400's error codes . The code displayed is {{ $labels.code }}"
          #receivers:

        - alert: 5xxDetected
          expr: rate(http_requests_total{job="http-simulator", status=~"5.."}[1m]) >= 1
          for: 2m
          labels:
            severity: "P1"
          annotations:
            summary: "The number of 5xx http status codes"
            description: "The service {{ $labels.job }} on instance {{ $labels.instance }} is experiencing a high number of HTTP 500's error codes . The HTTP status code is  {{ $labels.status }}"
          #receivers:


      - name: HTTP-SVC-SSL-CHECKS
        rules:
        ## SSL certificates issue
        - alert: SSLCertificatesExpiringIn14Days
          expr: timestamp(probe_ssl_earliest_cert_expiry) < 1209600
          for: 1h
          labels:
            severity: "P3"
            risk: "Disruption"
          annotations:
            summary: "SSL certificate expriring in 14 Days"
            description: "The service {{ $labels.job }} has got SSL certificates expriring in 14 days. The URL that the certificate belongs is {{ $labels.instance }}"
          #receivers:


        - alert: SSLCertificatesExpiringIn7Days
          expr: timestamp(probe_ssl_earliest_cert_expiry) < 604800
          for: 1h
          labels:
            severity: "P3"
            risk: "Disruption"
          annotations:
            summary: "SSL certificate expriring in 7 Days"
            description: "The service {{ $labels.job }} has got SSL certificates expriring in 7 days. The URL that the certificate belongs is {{ $labels.instance }}"
          #receivers:


        - alert: SSLCertificatesExpiringIn3Days
          expr: timestamp(probe_ssl_earliest_cert_expiry) < 302400
          for: 1h
          labels:
            severity: "P3"
            risk: "Disruption"
          annotations:
            summary: "SSL certificate expriring in 3 Days"
            description: "The service {{ $labels.job }} has got SSL certificates expriring in 3 days. The URL that the certificate belongs is {{ $labels.instance }}"
          #receivers:
    owner: root:root
    path: /etc/prometheus/alerts/alerts.default
    permissions: 0644
  - content: |
      [Unit]
      Description=Prometheus

      [Service]
      User=prometheus
      ExecStart=/opt/prometheus/prometheus --config.file="/etc/prometheus/prometheus.yml" --storage.tsdb.path="/mnt/prometheus" --log.level=debug
      WorkingDirectory=/opt/prometheus

      [Install]
      WantedBy = multi-user.target
    owner: root:root
    path: /etc/systemd/system/prometheus.service
    permissions: 0644
  - content: |
      [Unit]
      Description=Blackbox

      [Service]
      User=prometheus
      ExecStart=/opt/blackbox/blackbox_exporter --config.file="/etc/prometheus/blackbox.yml" --log.level=debug
      WorkingDirectory=/opt/blackbox

      [Install]
      WantedBy = multi-user.target
    owner: root:root
    path: /etc/systemd/system/blackbox.service
    permissions: 0644
  - content: |
      server {
        listen 80 default_server;
        server_name ${domain_name};
        auth_basic "Prometheus";
        auth_basic_user_file /etc/nginx/.htpasswd;

        location / {
          proxy_pass  http://localhost:9090;
        }
      }
      server {
        listen 8080;
        resolver 10.0.0.2;

        location / {
          proxy_pass https://$host$uri;
          proxy_ssl_server_name on;
          proxy_set_header X-CF-APP-INSTANCE $arg_cf_app_guid:$arg_cf_app_instance_index;
          proxy_set_header Authorization "Bearer $arg_cf_app_guid";
        }
      }
    owner: root:root
    path: /etc/nginx/sites-available/default
    permissions: 0644
  - owner: root:root
    path: /etc/cron.d/sync_prometheus_config_s3
    content: |
      PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
      */5 * * * * root aws s3 sync --delete s3://${config_bucket}/active /etc/prometheus/targets
  - owner: root:root
    path: /etc/cron.d/lets_encrypt_renewal
    content: |
      PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
      * 7,19 * * * root certbot renew --post-hook 'service nginx reload'
  - owner: root:root
    path: /etc/nginx/.htpasswd
    permissions: 0444
    content: "grafana:$apr1$LDmrTU1C$i1TWO7EiXgmVVOm3xkdpr0"
  - owner: root:root
    path: /etc/filebeat/filebeat.yml
    permissions: 0444
    content: |
      filebeat.prospectors:
      - type: log
        enabled: true
        paths:
          - /var/log/nginx/*.log
        fields:
          type: nginx-access
        fields_under_root: true
        encoding: utf-8
        exclude_files: [".gz"]
        ignore_older: 3h

      output.logstash:
        hosts: ["${logstash_endpoint}:${logstash_port}"]
        loadbalance: true
        ssl.enabled: true
runcmd:
  - [ whoami ]
  - [ deluser, ubuntu ]
  - [ service, sshd, restart ]
  - [ bash, -c, "echo 'server 169.254.169.123 prefer iburst' >> /etc/chrony/chrony.conf" ] # Configure Amazon Time Sync
  - [ service, chrony, restart ]
  - [ mkdir, /opt/prometheus ] # Extracted prometheus tarball
  - [ mkdir, /opt/blackbox ] # Extracted prometheus tarball
  - [ mkdir, /etc/prometheus/targets ] # Prometheus target configurations
  - [ wget, -q, "https://github.com/prometheus/prometheus/releases/download/v${prometheus_version}/prometheus-${prometheus_version}.linux-amd64.tar.gz", -P, /tmp ]
  - [ tar, xzvf, /tmp/prometheus-${prometheus_version}.linux-amd64.tar.gz, --strip-components=1, -C, /opt/prometheus ]
  - [ wget, -q, "https://github.com/prometheus/blackbox_exporter/releases/download/v0.12.0/blackbox_exporter-0.12.0.linux-amd64.tar.gz", -P, /tmp ]
  - [ tar, xzvf, /tmp/blackbox_exporter-0.12.0.linux-amd64.tar.gz, --strip-components=1, -C, /opt/blackbox ]
  - [ mkdir, -p, /mnt/prometheus ]
  - [ chown, -R, "prometheus:prometheus", /mnt/prometheus]
  - [ chown, -R, "prometheus:prometheus", /opt/prometheus ]
  - [ chown, -R, "prometheus:prometheus", /opt/blackbox ]
  - [ cp, /opt/blackbox/blackbox.yml, /etc/prometheus/blackbox.yml]
  - [ systemctl, enable, --now, prometheus.service ] # Start Prometheus
  - [ systemctl, enable, --now, blackbox.service ] # Start Prometheus
  - [ add-apt-repository, "ppa:certbot/certbot", -y ]
  - [ bash, -c, "echo 'deb https://artifacts.elastic.co/packages/6.x/apt stable main' >> /etc/apt/sources.list.d/elastic-6.x.list" ]
  - [ bash, -c, "wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | apt-key add -" ]
  - [ apt-get, update ]
  - 'apt-get install -o Dpkg::Options::="--force-confold" filebeat python-certbot-nginx -y'
  - [ certbot, ${real_certificate == "yes" ? "" : "--staging"}, -d, ${domain_name}, -m, ${lets_encrypt_email}, --authenticator, standalone, --installer, nginx, --pre-hook, "nginx -s stop", --post-hook, "nginx", --agree-tos, -n, --redirect ]
  - [ systemctl, enable, filebeat ]
  - [ reboot ]
